import{_ as s,c as n,o as a,a as e}from"./app.dd2a2f01.js";const d=JSON.parse('{"title":"Confused Deputy Protection","description":"","frontmatter":{},"headers":[{"level":2,"title":"Type confusion prevention","slug":"type-confusion-prevention","link":"#type-confusion-prevention","children":[]},{"level":2,"title":"Run-time system for confused deputy prevention","slug":"run-time-system-for-confused-deputy-prevention","link":"#run-time-system-for-confused-deputy-prevention","children":[]},{"level":2,"title":"Support for legacy code","slug":"support-for-legacy-code","link":"#support-for-legacy-code","children":[{"level":3,"title":"SCIF calls legacy","slug":"scif-calls-legacy","link":"#scif-calls-legacy","children":[]},{"level":3,"title":"legacy calls SCIF","slug":"legacy-calls-scif","link":"#legacy-calls-scif","children":[]}]}],"relativePath":"SecurityMechanisms/confused-deputy.md","lastUpdated":1747063617000}'),l={name:"SecurityMechanisms/confused-deputy.md"},o=e(`<h1 id="confused-deputy-protection" tabindex="-1">Confused Deputy Protection <a class="header-anchor" href="#confused-deputy-protection" aria-hidden="true">#</a></h1><p><em>The confused deputy attack</em> is a type of attack where a trusted principal (the confused deputy) is tricked into misusing its integrity by the attacker, and causing integrity failures as a result.</p><p><a href="https://rekt.news/polynetwork-rekt/" target="_blank" rel="noreferrer">The Poly Network Attack</a> is an example of the confused deputy attack. And it is the second biggest cryptocurrency hack ($611M stolen) to date. Poly Network provided a service in their contract <code>EthCrossChainManager</code> where users could ask the service to call other contracts for them. However, Poly Network didn&#39;t notice that <code>EthCrossChainManager</code> was actually calling other contracts on its own behalf, and the user tricked it to call another important contract: <code>EthCrossChainData</code>, which maintained high-integrity information and was supposed to be called only by highly trusted parties. Because <code>EthCrossChainData</code> trusted <code>EthCrossChainManager</code>, any user could manipulate data in <code>EthCrossChainData</code> by confusing <code>EthCrossChainManager</code>.</p><p>In the lens of information flow control, the confused deputy attack involves three parties: the attacker, the deputy, and the victim. The attacker is not trusted by the deputy nor the victim, and the deputy is trusted by the victim. The deputy opens some entry point that allows the attacker to call and ask the deputy to execute legitimate tasks on the attacker&#39;s behalf. If the attacker asks the deputy to call the victim, the victim should reject this call since the deputy is acting on the attacker&#39;s behalf and the victim doesn&#39;t trust the attacker. <em>The confused deputy attack happens when this call is accepted somehow</em>.</p><p>External calls in smart contracts are like remote procedure calls: the caller has limited information and control over the environment in which the callee runs, and vice versa. To get rid of confused deputy vulnerabilities, SCIF applied additional checking both statically and dynamically.</p><h2 id="type-confusion-prevention" tabindex="-1">Type confusion prevention <a class="header-anchor" href="#type-confusion-prevention" aria-hidden="true">#</a></h2><p>When compiling to Solidity, information flow labels are stripped off from the code. And because the way Solidity assigns identities to methods, two methods whose signatures only differ in labels will be assigned the same id. This leads to potential of confused deputy vulnerabilities. For example, <code>uint{this} g{this}(uint{this} value)</code> and <code>uint{any} g{this}(uint{this} value)</code> will be assigned the same id while they return values of different integrity level, resulting in potential information flow violation.</p><p>To get rid of method type confusion, SCIF embeds labels in method signatures in their names when compiling to Solidity. For example, the name of a method <code>uint{this} g{this}(uint{this} value)</code> will become <code>&quot;g&quot; + hash([&quot;this&quot;, &quot;this&quot;, &quot;this&quot;])</code>, when compiling to a Solidity function.</p><h2 id="run-time-system-for-confused-deputy-prevention" tabindex="-1">Run-time system for confused deputy prevention <a class="header-anchor" href="#run-time-system-for-confused-deputy-prevention" aria-hidden="true">#</a></h2><div class="language-scif"><button title="Copy Code" class="copy"></button><span class="lang">scif</span><pre><code><span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> f1</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">sender </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#D8DEE9FF;">final ContractTarget</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">sender</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">sender</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">target</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">g</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> f2</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">any </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#D8DEE9FF;">ContractTarget</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#88C0D0;">endorse</span><span style="color:#ECEFF4;">([</span><span style="color:#D8DEE9FF;">target</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">],</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">any </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">target</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">g</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> f3</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">any </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">constTarget</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">g</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> f4</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">any </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}()</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">constTarget</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">g</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">constValue</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> g</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">sender</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> in ContractTarget</span></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> g</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> in ContractRealTarget1</span></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> g</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> in ContractRealTarget2</span></span>
<span class="line"></span></code></pre></div><div class="language-scif"><button title="Copy Code" class="copy"></button><span class="lang">scif</span><pre><code><span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> f1</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">sender </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#D8DEE9FF;">final ContractTarget</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">sender</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">sender</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    assert sender </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    assert this </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">    assert target </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> this</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">target</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">g</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> g</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    checkHash</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    assert sender </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> this</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">in ContractTarget</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">this</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> g</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9;">l </span><span style="color:#81A1C1;">-&gt;</span><span style="color:#D8DEE9FF;"> </span><span style="color:#D8DEE9;">this</span><span style="color:#ECEFF4;">}(</span><span style="color:#81A1C1;">uint</span><span style="color:#ECEFF4;">{</span><span style="color:#D8DEE9FF;">any</span><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> value</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    checkHash</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    assert sender </span><span style="color:#81A1C1;">=&gt;</span><span style="color:#D8DEE9FF;"> l</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // if sender =&gt; l, can we trust sender calls in the right pc</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="support-for-legacy-code" tabindex="-1">Support for legacy code <a class="header-anchor" href="#support-for-legacy-code" aria-hidden="true">#</a></h2><p>When a SCIF contract calls a method in a legacy contract, its signature will be filled conservatively, promising the lowest level security gurantees. Any entry-point will be treated as a method that requires no integrity level and autoendorse to this, respects no locks and returns low-level values.</p><p>When a legacy contract calls a method in a SCIF contract, it is expected that the method pointer points to the method whose legacy method name matches the hash of the method signature.</p><h3 id="scif-calls-legacy" tabindex="-1">SCIF calls legacy <a class="header-anchor" href="#scif-calls-legacy" aria-hidden="true">#</a></h3><h3 id="legacy-calls-scif" tabindex="-1">legacy calls SCIF <a class="header-anchor" href="#legacy-calls-scif" aria-hidden="true">#</a></h3>`,16),t=[o];function p(c,r,E,F,y,i){return a(),n("div",null,t)}const h=s(l,[["render",p]]);export{d as __pageData,h as default};
